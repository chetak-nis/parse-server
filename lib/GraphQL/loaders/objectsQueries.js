"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.load = exports.findObjects = exports.getObject = void 0;

var _graphql = require("graphql");

var _graphqlListFields = _interopRequireDefault(require("graphql-list-fields"));

var _node = _interopRequireDefault(require("parse/node"));

var defaultGraphQLTypes = _interopRequireWildcard(require("./defaultGraphQLTypes"));

var _rest = _interopRequireDefault(require("../../rest"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const getObject = async (className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info) => {
  const options = {};

  if (keys) {
    options.keys = keys;
  }

  if (include) {
    options.include = include;

    if (includeReadPreference) {
      options.includeReadPreference = includeReadPreference;
    }
  }

  if (readPreference) {
    options.readPreference = readPreference;
  }

  const response = await _rest.default.get(config, auth, className, objectId, options, info.clientSDK);

  if (!response.results || response.results.length == 0) {
    throw new _node.default.Error(_node.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
  }

  if (className === '_User') {
    delete response.results[0].sessionToken;
  }

  return response.results[0];
};

exports.getObject = getObject;
const parseMap = {
  _or: '$or',
  _and: '$and',
  _nor: '$nor',
  _relatedTo: '$relatedTo',
  _eq: '$eq',
  _ne: '$ne',
  _lt: '$lt',
  _lte: '$lte',
  _gt: '$gt',
  _gte: '$gte',
  _in: '$in',
  _nin: '$nin',
  _exists: '$exists',
  _select: '$select',
  _dontSelect: '$dontSelect',
  _inQuery: '$inQuery',
  _notInQuery: '$notInQuery',
  _containedBy: '$containedBy',
  _all: '$all',
  _regex: '$regex',
  _options: '$options',
  _text: '$text',
  _search: '$search',
  _term: '$term',
  _language: '$language',
  _caseSensitive: '$caseSensitive',
  _diacriticSensitive: '$diacriticSensitive',
  _nearSphere: '$nearSphere',
  _maxDistance: '$maxDistance',
  _maxDistanceInRadians: '$maxDistanceInRadians',
  _maxDistanceInMiles: '$maxDistanceInMiles',
  _maxDistanceInKilometers: '$maxDistanceInKilometers',
  _within: '$within',
  _box: '$box',
  _geoWithin: '$geoWithin',
  _polygon: '$polygon',
  _centerSphere: '$centerSphere',
  _geoIntersects: '$geoIntersects',
  _point: '$point'
};

const transformToParse = constraints => {
  if (!constraints || typeof constraints !== 'object') {
    return;
  }

  Object.keys(constraints).forEach(fieldName => {
    let fieldValue = constraints[fieldName];

    if (parseMap[fieldName]) {
      delete constraints[fieldName];
      fieldName = parseMap[fieldName];
      constraints[fieldName] = fieldValue;
    }

    switch (fieldName) {
      case '$point':
      case '$nearSphere':
        if (typeof fieldValue === 'object' && !fieldValue.__type) {
          fieldValue.__type = 'GeoPoint';
        }

        break;

      case '$box':
        if (typeof fieldValue === 'object' && fieldValue.bottomLeft && fieldValue.upperRight) {
          fieldValue = [_objectSpread({
            __type: 'GeoPoint'
          }, fieldValue.bottomLeft), _objectSpread({
            __type: 'GeoPoint'
          }, fieldValue.upperRight)];
          constraints[fieldName] = fieldValue;
        }

        break;

      case '$polygon':
        if (fieldValue instanceof Array) {
          fieldValue.forEach(geoPoint => {
            if (typeof geoPoint === 'object' && !geoPoint.__type) {
              geoPoint.__type = 'GeoPoint';
            }
          });
        }

        break;

      case '$centerSphere':
        if (typeof fieldValue === 'object' && fieldValue.center && fieldValue.distance) {
          fieldValue = [_objectSpread({
            __type: 'GeoPoint'
          }, fieldValue.center), fieldValue.distance];
          constraints[fieldName] = fieldValue;
        }

        break;
    }

    if (typeof fieldValue === 'object') {
      transformToParse(fieldValue);
    }
  });
};

const findObjects = async (className, where, order, skip, limit, keys, include, includeAll, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields) => {
  if (!where) {
    where = {};
  }

  transformToParse(where);
  const options = {};

  if (selectedFields.includes('results')) {
    if (limit || limit === 0) {
      options.limit = limit;
    }

    if (options.limit !== 0) {
      if (order) {
        options.order = order;
      }

      if (skip) {
        options.skip = skip;
      }

      if (config.maxLimit && options.limit > config.maxLimit) {
        // Silently replace the limit on the query with the max configured
        options.limit = config.maxLimit;
      }

      if (keys) {
        options.keys = keys;
      }

      if (includeAll === true) {
        options.includeAll = includeAll;
      }

      if (!options.includeAll && include) {
        options.include = include;
      }

      if ((options.includeAll || options.include) && includeReadPreference) {
        options.includeReadPreference = includeReadPreference;
      }
    }
  } else {
    options.limit = 0;
  }

  if (selectedFields.includes('count')) {
    options.count = true;
  }

  if (readPreference) {
    options.readPreference = readPreference;
  }

  if (Object.keys(where).length > 0 && subqueryReadPreference) {
    options.subqueryReadPreference = subqueryReadPreference;
  }

  return await _rest.default.find(config, auth, className, where, options, info.clientSDK);
};

exports.findObjects = findObjects;

const load = parseGraphQLSchema => {
  parseGraphQLSchema.graphQLObjectsQueries.get = {
    description: 'The get query can be used to get an object of a certain class by its objectId.',
    args: {
      className: defaultGraphQLTypes.CLASS_NAME_ATT,
      objectId: defaultGraphQLTypes.OBJECT_ID_ATT,
      keys: defaultGraphQLTypes.KEYS_ATT,
      include: defaultGraphQLTypes.INCLUDE_ATT,
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.OBJECT),

    async resolve(_source, args, context) {
      try {
        const {
          className,
          objectId,
          keys,
          include,
          readPreference,
          includeReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        return await getObject(className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  };
  parseGraphQLSchema.graphQLObjectsQueries.find = {
    description: 'The find query can be used to find objects of a certain class.',
    args: {
      className: defaultGraphQLTypes.CLASS_NAME_ATT,
      where: defaultGraphQLTypes.WHERE_ATT,
      order: {
        description: 'This is the order in which the objects should be returned',
        type: _graphql.GraphQLString
      },
      skip: defaultGraphQLTypes.SKIP_ATT,
      limit: defaultGraphQLTypes.LIMIT_ATT,
      keys: defaultGraphQLTypes.KEYS_ATT,
      include: defaultGraphQLTypes.INCLUDE_ATT,
      includeAll: {
        description: 'All pointers will be returned',
        type: _graphql.GraphQLBoolean
      },
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT,
      subqueryReadPreference: defaultGraphQLTypes.SUBQUERY_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.FIND_RESULT),

    async resolve(_source, args, context, queryInfo) {
      try {
        const {
          className,
          where,
          order,
          skip,
          limit,
          keys,
          include,
          includeAll,
          readPreference,
          includeReadPreference,
          subqueryReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        const selectedFields = (0, _graphqlListFields.default)(queryInfo);
        return await findObjects(className, where, order, skip, limit, keys, include, includeAll, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  };
  const objectsQuery = new _graphql.GraphQLObjectType({
    name: 'ObjectsQuery',
    description: 'ObjectsQuery is the top level type for objects queries.',
    fields: parseGraphQLSchema.graphQLObjectsQueries
  });
  parseGraphQLSchema.graphQLTypes.push(objectsQuery);
  parseGraphQLSchema.graphQLQueries.objects = {
    description: 'This is the top level for objects queries.',
    type: objectsQuery,
    resolve: () => new Object()
  };
};

exports.load = load;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HcmFwaFFML2xvYWRlcnMvb2JqZWN0c1F1ZXJpZXMuanMiXSwibmFtZXMiOlsiZ2V0T2JqZWN0IiwiY2xhc3NOYW1lIiwib2JqZWN0SWQiLCJrZXlzIiwiaW5jbHVkZSIsInJlYWRQcmVmZXJlbmNlIiwiaW5jbHVkZVJlYWRQcmVmZXJlbmNlIiwiY29uZmlnIiwiYXV0aCIsImluZm8iLCJvcHRpb25zIiwicmVzcG9uc2UiLCJyZXN0IiwiZ2V0IiwiY2xpZW50U0RLIiwicmVzdWx0cyIsImxlbmd0aCIsIlBhcnNlIiwiRXJyb3IiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwic2Vzc2lvblRva2VuIiwicGFyc2VNYXAiLCJfb3IiLCJfYW5kIiwiX25vciIsIl9yZWxhdGVkVG8iLCJfZXEiLCJfbmUiLCJfbHQiLCJfbHRlIiwiX2d0IiwiX2d0ZSIsIl9pbiIsIl9uaW4iLCJfZXhpc3RzIiwiX3NlbGVjdCIsIl9kb250U2VsZWN0IiwiX2luUXVlcnkiLCJfbm90SW5RdWVyeSIsIl9jb250YWluZWRCeSIsIl9hbGwiLCJfcmVnZXgiLCJfb3B0aW9ucyIsIl90ZXh0IiwiX3NlYXJjaCIsIl90ZXJtIiwiX2xhbmd1YWdlIiwiX2Nhc2VTZW5zaXRpdmUiLCJfZGlhY3JpdGljU2Vuc2l0aXZlIiwiX25lYXJTcGhlcmUiLCJfbWF4RGlzdGFuY2UiLCJfbWF4RGlzdGFuY2VJblJhZGlhbnMiLCJfbWF4RGlzdGFuY2VJbk1pbGVzIiwiX21heERpc3RhbmNlSW5LaWxvbWV0ZXJzIiwiX3dpdGhpbiIsIl9ib3giLCJfZ2VvV2l0aGluIiwiX3BvbHlnb24iLCJfY2VudGVyU3BoZXJlIiwiX2dlb0ludGVyc2VjdHMiLCJfcG9pbnQiLCJ0cmFuc2Zvcm1Ub1BhcnNlIiwiY29uc3RyYWludHMiLCJPYmplY3QiLCJmb3JFYWNoIiwiZmllbGROYW1lIiwiZmllbGRWYWx1ZSIsIl9fdHlwZSIsImJvdHRvbUxlZnQiLCJ1cHBlclJpZ2h0IiwiQXJyYXkiLCJnZW9Qb2ludCIsImNlbnRlciIsImRpc3RhbmNlIiwiZmluZE9iamVjdHMiLCJ3aGVyZSIsIm9yZGVyIiwic2tpcCIsImxpbWl0IiwiaW5jbHVkZUFsbCIsInN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UiLCJzZWxlY3RlZEZpZWxkcyIsImluY2x1ZGVzIiwibWF4TGltaXQiLCJjb3VudCIsImZpbmQiLCJsb2FkIiwicGFyc2VHcmFwaFFMU2NoZW1hIiwiZ3JhcGhRTE9iamVjdHNRdWVyaWVzIiwiZGVzY3JpcHRpb24iLCJhcmdzIiwiZGVmYXVsdEdyYXBoUUxUeXBlcyIsIkNMQVNTX05BTUVfQVRUIiwiT0JKRUNUX0lEX0FUVCIsIktFWVNfQVRUIiwiSU5DTFVERV9BVFQiLCJSRUFEX1BSRUZFUkVOQ0VfQVRUIiwiSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwidHlwZSIsIkdyYXBoUUxOb25OdWxsIiwiT0JKRUNUIiwicmVzb2x2ZSIsIl9zb3VyY2UiLCJjb250ZXh0IiwiZSIsImhhbmRsZUVycm9yIiwiV0hFUkVfQVRUIiwiR3JhcGhRTFN0cmluZyIsIlNLSVBfQVRUIiwiTElNSVRfQVRUIiwiR3JhcGhRTEJvb2xlYW4iLCJTVUJRVUVSWV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwiRklORF9SRVNVTFQiLCJxdWVyeUluZm8iLCJvYmplY3RzUXVlcnkiLCJHcmFwaFFMT2JqZWN0VHlwZSIsIm5hbWUiLCJmaWVsZHMiLCJncmFwaFFMVHlwZXMiLCJwdXNoIiwiZ3JhcGhRTFF1ZXJpZXMiLCJvYmplY3RzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBTUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7O0FBRUEsTUFBTUEsU0FBUyxHQUFHLE9BQ2hCQyxTQURnQixFQUVoQkMsUUFGZ0IsRUFHaEJDLElBSGdCLEVBSWhCQyxPQUpnQixFQUtoQkMsY0FMZ0IsRUFNaEJDLHFCQU5nQixFQU9oQkMsTUFQZ0IsRUFRaEJDLElBUmdCLEVBU2hCQyxJQVRnQixLQVViO0FBQ0gsUUFBTUMsT0FBTyxHQUFHLEVB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QU10QixjQUFjLEdBQUcsZ0NBQWNnQyxTQUFkLENBQXZCO0FBRUEsZUFBTyxNQUFNdkMsV0FBVyxDQUN0QnpFLFNBRHNCLEVBRXRCMEUsS0FGc0IsRUFHdEJDLEtBSHNCLEVBSXRCQyxJQUpzQixFQUt0QkMsS0FMc0IsRUFNdEIzRSxJQU5zQixFQU90QkMsT0FQc0IsRUFRdEIyRSxVQVJzQixFQVN0QjFFLGNBVHNCLEVBVXRCQyxxQkFWc0IsRUFXdEIwRSxzQkFYc0IsRUFZdEJ6RSxNQVpzQixFQWF0QkMsSUFic0IsRUFjdEJDLElBZHNCLEVBZXRCd0UsY0Fmc0IsQ0FBeEI7QUFpQkQsT0FsQ0QsQ0FrQ0UsT0FBT3VCLENBQVAsRUFBVTtBQUNWakIsUUFBQUEsa0JBQWtCLENBQUNrQixXQUFuQixDQUErQkQsQ0FBL0I7QUFDRDtBQUNGOztBQTlENkMsR0FBaEQ7QUFpRUEsUUFBTVUsWUFBWSxHQUFHLElBQUlDLDBCQUFKLENBQXNCO0FBQ3pDQyxJQUFBQSxJQUFJLEVBQUUsY0FEbUM7QUFFekMzQixJQUFBQSxXQUFXLEVBQUUseURBRjRCO0FBR3pDNEIsSUFBQUEsTUFBTSxFQUFFOUIsa0JBQWtCLENBQUNDO0FBSGMsR0FBdEIsQ0FBckI7QUFLQUQsRUFBQUEsa0JBQWtCLENBQUMrQixZQUFuQixDQUFnQ0MsSUFBaEMsQ0FBcUNMLFlBQXJDO0FBRUEzQixFQUFBQSxrQkFBa0IsQ0FBQ2lDLGNBQW5CLENBQWtDQyxPQUFsQyxHQUE0QztBQUMxQ2hDLElBQUFBLFdBQVcsRUFBRSw0Q0FENkI7QUFFMUNTLElBQUFBLElBQUksRUFBRWdCLFlBRm9DO0FBRzFDYixJQUFBQSxPQUFPLEVBQUUsTUFBTSxJQUFJdEMsTUFBSjtBQUgyQixHQUE1QztBQUtELENBdkhEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgR3JhcGhRTE5vbk51bGwsXG4gIEdyYXBoUUxCb29sZWFuLFxuICBHcmFwaFFMU3RyaW5nLFxuICBHcmFwaFFMT2JqZWN0VHlwZSxcbn0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgZ2V0RmllbGROYW1lcyBmcm9tICdncmFwaHFsLWxpc3QtZmllbGRzJztcbmltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcbmltcG9ydCAqIGFzIGRlZmF1bHRHcmFwaFFMVHlwZXMgZnJvbSAnLi9kZWZhdWx0R3JhcGhRTFR5cGVzJztcbmltcG9ydCByZXN0IGZyb20gJy4uLy4uL3Jlc3QnO1xuXG5jb25zdCBnZXRPYmplY3QgPSBhc3luYyAoXG4gIGNsYXNzTmFtZSxcbiAgb2JqZWN0SWQsXG4gIGtleXMsXG4gIGluY2x1ZGUsXG4gIHJlYWRQcmVmZXJlbmNlLFxuICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gIGNvbmZpZyxcbiAgYXV0aCxcbiAgaW5mb1xuKSA9PiB7XG4gIGNvbnN0IG9wdGlvbnMgPSB7fTtcbiAgaWYgKGtleXMpIHtcbiAgICBvcHRpb25zLmtleXMgPSBrZXlzO1xuICB9XG4gIGlmIChpbmNsdWRlKSB7XG4gICAgb3B0aW9ucy5pbmNsdWRlID0gaW5jbHVkZTtcbiAgICBpZiAoaW5jbHVkZVJlYWRQcmVmZXJlbmNlKSB7XG4gICAgICBvcHRpb25zLmluY2x1ZGVSZWFkUHJlZmVyZW5jZSA9IGluY2x1ZGVSZWFkUHJlZmVyZW5jZTtcbiAgICB9XG4gIH1cbiAgaWYgKHJlYWRQcmVmZXJlbmNlKSB7XG4gICAgb3B0aW9ucy5yZWFkUHJlZmVyZW5jZSA9IHJlYWRQcmVmZXJlbmNlO1xuICB9XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXN0LmdldChcbiAgICBjb25maWcsXG4gICAgYXV0aCxcbiAgICBjbGFzc05hbWUsXG4gICAgb2JqZWN0SWQsXG4gICAgb3B0aW9ucyxcbiAgICBpbmZvLmNsaWVudFNES1xuICApO1xuXG4gIGlmICghcmVzcG9uc2UucmVzdWx0cyB8fCByZXNwb25zZS5yZXN1bHRzLmxlbmd0aCA9PSAwKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsICdPYmplY3Qgbm90IGZvdW5kLicpO1xuICB9XG5cbiAgaWYgKGNsYXNzTmFtZSA9PT0gJ19Vc2VyJykge1xuICAgIGRlbGV0ZSByZXNwb25zZS5yZXN1bHRzWzBdLnNlc3Npb25Ub2tlbjtcbiAgfVxuXG4gIHJldHVybiByZXNwb25zZS5yZXN1bHRzWzBdO1xufTtcblxuY29uc3QgcGFyc2VNYXAgPSB7XG4gIF9vcjogJyRvcicsXG4gIF9hbmQ6ICckYW5kJyxcbiAgX25vcjogJyRub3InLFxuICBfcmVsYXRlZFRvOiAnJHJlbGF0ZWRUbycsXG4gIF9lcTogJyRlcScsXG4gIF9uZTogJyRuZScsXG4gIF9sdDogJyRsdCcsXG4gIF9sdGU6ICckbHRlJyxcbiAgX2d0OiAnJGd0JyxcbiAgX2d0ZTogJyRndGUnLFxuICBfaW46ICckaW4nLFxuICBfbmluOiAnJG5pbicsXG4gIF9leGlzdHM6ICckZXhpc3RzJyxcbiAgX3NlbGVjdDogJyRzZWxlY3QnLFxuICBfZG9udFNlbGVjdDogJyRkb250U2VsZWN0JyxcbiAgX2luUXVlcnk6ICckaW5RdWVyeScsXG4gIF9ub3RJblF1ZXJ5OiAnJG5vdEluUXVlcnknLFxuICBfY29udGFpbmVkQnk6ICckY29udGFpbmVkQnknLFxuICBfYWxsOiAnJGFsbCcsXG4gIF9yZWdleDogJyRyZWdleCcsXG4gIF9vcHRpb25zOiAnJG9wdGlvbnMnLFxuICBfdGV4dDogJyR0ZXh0JyxcbiAgX3NlYXJjaDogJyRzZWFyY2gnLFxuICBfdGVybTogJyR0ZXJtJyxcbiAgX2xhbmd1YWdlOiAnJGxhbmd1YWdlJyxcbiAgX2Nhc2VTZW5zaXRpdmU6ICckY2FzZVNlbnNpdGl2ZScsXG4gIF9kaWFjcml0aWNTZW5zaXRpdmU6ICckZGlhY3JpdGljU2Vuc2l0aXZlJyxcbiAgX25lYXJTcGhlcmU6ICckbmVhclNwaGVyZScsXG4gIF9tYXhEaXN0YW5jZTogJyRtYXhEaXN0YW5jZScsXG4gIF9tYXhEaXN0YW5jZUluUmFkaWFuczogJyRtYXhEaXN0YW5jZUluUmFkaWFucycsXG4gIF9tYXhEaXN0YW5jZUluTWlsZXM6ICckbWF4RGlzdGFuY2VJbk1pbGVzJyxcbiAgX21heERpc3RhbmNlSW5LaWxvbWV0ZXJzOiAnJG1heERpc3RhbmNlSW5LaWxvbWV0ZXJzJyxcbiAgX3dpdGhpbjogJyR3aXRoaW4nLFxuICBfYm94OiAnJGJveCcsXG4gIF9nZW9XaXRoaW46ICckZ2VvV2l0aGluJyxcbiAgX3BvbHlnb246ICckcG9seWdvbicsXG4gIF9jZW50ZXJTcGhlcmU6ICckY2VudGVyU3BoZXJlJyxcbiAgX2dlb0ludGVyc2VjdHM6ICckZ2VvSW50ZXJzZWN0cycsXG4gIF9wb2ludDogJyRwb2ludCcsXG59O1xuXG5jb25zdCB0cmFuc2Zvcm1Ub1BhcnNlID0gY29uc3RyYWludHMgPT4ge1xuICBpZiAoIWNvbnN0cmFpbnRzIHx8IHR5cGVvZiBjb25zdHJhaW50cyAhPT0gJ29iamVjdCcpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgT2JqZWN0LmtleXMoY29uc3RyYWludHMpLmZvckVhY2goZmllbGROYW1lID0+IHtcbiAgICBsZXQgZmllbGRWYWx1ZSA9IGNvbnN0cmFpbnRzW2ZpZWxkTmFtZV07XG4gICAgaWYgKHBhcnNlTWFwW2ZpZWxkTmFtZV0pIHtcbiAgICAgIGRlbGV0ZSBjb25zdHJhaW50c1tmaWVsZE5hbWVdO1xuICAgICAgZmllbGROYW1lID0gcGFyc2VNYXBbZmllbGROYW1lXTtcbiAgICAgIGNvbnN0cmFpbnRzW2ZpZWxkTmFtZV0gPSBmaWVsZFZhbHVlO1xuICAgIH1cbiAgICBzd2l0Y2ggKGZpZWxkTmFtZSkge1xuICAgICAgY2FzZSAnJHBvaW50JzpcbiAgICAgIGNhc2UgJyRuZWFyU3BoZXJlJzpcbiAgICAgICAgaWYgKHR5cGVvZiBmaWVsZFZhbHVlID09PSAnb2JqZWN0JyAmJiAhZmllbGRWYWx1ZS5fX3R5cGUpIHtcbiAgICAgICAgICBmaWVsZFZhbHVlLl9fdHlwZSA9ICdHZW9Qb2ludCc7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICckYm94JzpcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHR5cGVvZiBmaWVsZFZhbHVlID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAgIGZpZWxkVmFsdWUuYm90dG9tTGVmdCAmJlxuICAgICAgICAgIGZpZWxkVmFsdWUudXBwZXJSaWdodFxuICAgICAgICApIHtcbiAgICAgICAgICBmaWVsZFZhbHVlID0gW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBfX3R5cGU6ICdHZW9Qb2ludCcsXG4gICAgICAgICAgICAgIC4uLmZpZWxkVmFsdWUuYm90dG9tTGVmdCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIF9fdHlwZTogJ0dlb1BvaW50JyxcbiAgICAgICAgICAgICAgLi4uZmllbGRWYWx1ZS51cHBlclJpZ2h0LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdO1xuICAgICAgICAgIGNvbnN0cmFpbnRzW2ZpZWxkTmFtZV0gPSBmaWVsZFZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnJHBvbHlnb24nOlxuICAgICAgICBpZiAoZmllbGRWYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgZmllbGRWYWx1ZS5mb3JFYWNoKGdlb1BvaW50ID0+IHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZ2VvUG9pbnQgPT09ICdvYmplY3QnICYmICFnZW9Qb2ludC5fX3R5cGUpIHtcbiAgICAgICAgICAgICAgZ2VvUG9pbnQuX190eXBlID0gJ0dlb1BvaW50JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJyRjZW50ZXJTcGhlcmUnOlxuICAgICAgICBpZiAoXG4gICAgICAgICAgdHlwZW9mIGZpZWxkVmFsdWUgPT09ICdvYmplY3QnICYmXG4gICAgICAgICAgZmllbGRWYWx1ZS5jZW50ZXIgJiZcbiAgICAgICAgICBmaWVsZFZhbHVlLmRpc3RhbmNlXG4gICAgICAgICkge1xuICAgICAgICAgIGZpZWxkVmFsdWUgPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIF9fdHlwZTogJ0dlb1BvaW50JyxcbiAgICAgICAgICAgICAgLi4uZmllbGRWYWx1ZS5jZW50ZXIsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmllbGRWYWx1ZS5kaXN0YW5jZSxcbiAgICAgICAgICBdO1xuICAgICAgICAgIGNvbnN0cmFpbnRzW2ZpZWxkTmFtZV0gPSBmaWVsZFZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGZpZWxkVmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICB0cmFuc2Zvcm1Ub1BhcnNlKGZpZWxkVmFsdWUpO1xuICAgIH1cbiAgfSk7XG59O1xuXG5jb25zdCBmaW5kT2JqZWN0cyA9IGFzeW5jIChcbiAgY2xhc3NOYW1lLFxuICB3aGVyZSxcbiAgb3JkZXIsXG4gIHNraXAsXG4gIGxpbWl0LFxuICBrZXlzLFxuICBpbmNsdWRlLFxuICBpbmNsdWRlQWxsLFxuICByZWFkUHJlZmVyZW5jZSxcbiAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlLFxuICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICBjb25maWcsXG4gIGF1dGgsXG4gIGluZm8sXG4gIHNlbGVjdGVkRmllbGRzXG4pID0+IHtcbiAgaWYgKCF3aGVyZSkge1xuICAgIHdoZXJlID0ge307XG4gIH1cblxuICB0cmFuc2Zvcm1Ub1BhcnNlKHdoZXJlKTtcblxuICBjb25zdCBvcHRpb25zID0ge307XG5cbiAgaWYgKHNlbGVjdGVkRmllbGRzLmluY2x1ZGVzKCdyZXN1bHRzJykpIHtcbiAgICBpZiAobGltaXQgfHwgbGltaXQgPT09IDApIHtcbiAgICAgIG9wdGlvbnMubGltaXQgPSBsaW1pdDtcbiAgICB9XG4gICAgaWYgKG9wdGlvbnMubGltaXQgIT09IDApIHtcbiAgICAgIGlmIChvcmRlcikge1xuICAgICAgICBvcHRpb25zLm9yZGVyID0gb3JkZXI7XG4gICAgICB9XG4gICAgICBpZiAoc2tpcCkge1xuICAgICAgICBvcHRpb25zLnNraXAgPSBza2lwO1xuICAgICAgfVxuICAgICAgaWYgKGNvbmZpZy5tYXhMaW1pdCAmJiBvcHRpb25zLmxpbWl0ID4gY29uZmlnLm1heExpbWl0KSB7XG4gICAgICAgIC8vIFNpbGVudGx5IHJlcGxhY2UgdGhlIGxpbWl0IG9uIHRoZSBxdWVyeSB3aXRoIHRoZSBtYXggY29uZmlndXJlZFxuICAgICAgICBvcHRpb25zLmxpbWl0ID0gY29uZmlnLm1heExpbWl0O1xuICAgICAgfVxuICAgICAgaWYgKGtleXMpIHtcbiAgICAgICAgb3B0aW9ucy5rZXlzID0ga2V5cztcbiAgICAgIH1cbiAgICAgIGlmIChpbmNsdWRlQWxsID09PSB0cnVlKSB7XG4gICAgICAgIG9wdGlvbnMuaW5jbHVkZUFsbCA9IGluY2x1ZGVBbGw7XG4gICAgICB9XG4gICAgICBpZiAoIW9wdGlvbnMuaW5jbHVkZUFsbCAmJiBpbmNsdWRlKSB7XG4gICAgICAgIG9wdGlvbnMuaW5jbHVkZSA9IGluY2x1ZGU7XG4gICAgICB9XG4gICAgICBpZiAoKG9wdGlvbnMuaW5jbHVkZUFsbCB8fCBvcHRpb25zLmluY2x1ZGUpICYmIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSkge1xuICAgICAgICBvcHRpb25zLmluY2x1ZGVSZWFkUHJlZmVyZW5jZSA9IGluY2x1ZGVSZWFkUHJlZmVyZW5jZTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgb3B0aW9ucy5saW1pdCA9IDA7XG4gIH1cblxuICBpZiAoc2VsZWN0ZWRGaWVsZHMuaW5jbHVkZXMoJ2NvdW50JykpIHtcbiAgICBvcHRpb25zLmNvdW50ID0gdHJ1ZTtcbiAgfVxuXG4gIGlmIChyZWFkUHJlZmVyZW5jZSkge1xuICAgIG9wdGlvbnMucmVhZFByZWZlcmVuY2UgPSByZWFkUHJlZmVyZW5jZTtcbiAgfVxuICBpZiAoT2JqZWN0LmtleXMod2hlcmUpLmxlbmd0aCA+IDAgJiYgc3VicXVlcnlSZWFkUHJlZmVyZW5jZSkge1xuICAgIG9wdGlvbnMuc3VicXVlcnlSZWFkUHJlZmVyZW5jZSA9IHN1YnF1ZXJ5UmVhZFByZWZlcmVuY2U7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgcmVzdC5maW5kKFxuICAgIGNvbmZpZyxcbiAgICBhdXRoLFxuICAgIGNsYXNzTmFtZSxcbiAgICB3aGVyZSxcbiAgICBvcHRpb25zLFxuICAgIGluZm8uY2xpZW50U0RLXG4gICk7XG59O1xuXG5jb25zdCBsb2FkID0gcGFyc2VHcmFwaFFMU2NoZW1hID0+IHtcbiAgcGFyc2VHcmFwaFFMU2NoZW1hLmdyYXBoUUxPYmplY3RzUXVlcmllcy5nZXQgPSB7XG4gICAgZGVzY3JpcHRpb246XG4gICAgICAnVGhlIGdldCBxdWVyeSBjYW4gYmUgdXNlZCB0byBnZXQgYW4gb2JqZWN0IG9mIGEgY2VydGFpbiBjbGFzcyBieSBpdHMgb2JqZWN0SWQuJyxcbiAgICBhcmdzOiB7XG4gICAgICBjbGFzc05hbWU6IGRlZmF1bHRHcmFwaFFMVHlwZXMuQ0xBU1NfTkFNRV9BVFQsXG4gICAgICBvYmplY3RJZDogZGVmYXVsdEdyYXBoUUxUeXBlcy5PQkpFQ1RfSURfQVRULFxuICAgICAga2V5czogZGVmYXVsdEdyYXBoUUxUeXBlcy5LRVlTX0FUVCxcbiAgICAgIGluY2x1ZGU6IGRlZmF1bHRHcmFwaFFMVHlwZXMuSU5DTFVERV9BVFQsXG4gICAgICByZWFkUHJlZmVyZW5jZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgICAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLklOQ0xVREVfUkVBRF9QUkVGRVJFTkNFX0FUVCxcbiAgICB9LFxuICAgIHR5cGU6IG5ldyBHcmFwaFFMTm9uTnVsbChkZWZhdWx0R3JhcGhRTFR5cGVzLk9CSkVDVCksXG4gICAgYXN5bmMgcmVzb2x2ZShfc291cmNlLCBhcmdzLCBjb250ZXh0KSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICAgIG9iamVjdElkLFxuICAgICAgICAgIGtleXMsXG4gICAgICAgICAgaW5jbHVkZSxcbiAgICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgIH0gPSBhcmdzO1xuICAgICAgICBjb25zdCB7IGNvbmZpZywgYXV0aCwgaW5mbyB9ID0gY29udGV4dDtcblxuICAgICAgICByZXR1cm4gYXdhaXQgZ2V0T2JqZWN0KFxuICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICBvYmplY3RJZCxcbiAgICAgICAgICBrZXlzLFxuICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIGluZm9cbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcGFyc2VHcmFwaFFMU2NoZW1hLmhhbmRsZUVycm9yKGUpO1xuICAgICAgfVxuICAgIH0sXG4gIH07XG5cbiAgcGFyc2VHcmFwaFFMU2NoZW1hLmdyYXBoUUxPYmplY3RzUXVlcmllcy5maW5kID0ge1xuICAgIGRlc2NyaXB0aW9uOlxuICAgICAgJ1RoZSBmaW5kIHF1ZXJ5IGNhbiBiZSB1c2VkIHRvIGZpbmQgb2JqZWN0cyBvZiBhIGNlcnRhaW4gY2xhc3MuJyxcbiAgICBhcmdzOiB7XG4gICAgICBjbGFzc05hbWU6IGRlZmF1bHRHcmFwaFFMVHlwZXMuQ0xBU1NfTkFNRV9BVFQsXG4gICAgICB3aGVyZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5XSEVSRV9BVFQsXG4gICAgICBvcmRlcjoge1xuICAgICAgICBkZXNjcmlwdGlvbjpcbiAgICAgICAgICAnVGhpcyBpcyB0aGUgb3JkZXIgaW4gd2hpY2ggdGhlIG9iamVjdHMgc2hvdWxkIGJlIHJldHVybmVkJyxcbiAgICAgICAgdHlwZTogR3JhcGhRTFN0cmluZyxcbiAgICAgIH0sXG4gICAgICBza2lwOiBkZWZhdWx0R3JhcGhRTFR5cGVzLlNLSVBfQVRULFxuICAgICAgbGltaXQ6IGRlZmF1bHRHcmFwaFFMVHlwZXMuTElNSVRfQVRULFxuICAgICAga2V5czogZGVmYXVsdEdyYXBoUUxUeXBlcy5LRVlTX0FUVCxcbiAgICAgIGluY2x1ZGU6IGRlZmF1bHRHcmFwaFFMVHlwZXMuSU5DTFVERV9BVFQsXG4gICAgICBpbmNsdWRlQWxsOiB7XG4gICAgICAgIGRlc2NyaXB0aW9uOiAnQWxsIHBvaW50ZXJzIHdpbGwgYmUgcmV0dXJuZWQnLFxuICAgICAgICB0eXBlOiBHcmFwaFFMQm9vbGVhbixcbiAgICAgIH0sXG4gICAgICByZWFkUHJlZmVyZW5jZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgICAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLklOQ0xVREVfUkVBRF9QUkVGRVJFTkNFX0FUVCxcbiAgICAgIHN1YnF1ZXJ5UmVhZFByZWZlcmVuY2U6IGRlZmF1bHRHcmFwaFFMVHlwZXMuU1VCUVVFUllfUkVBRF9QUkVGRVJFTkNFX0FUVCxcbiAgICB9LFxuICAgIHR5cGU6IG5ldyBHcmFwaFFMTm9uTnVsbChkZWZhdWx0R3JhcGhRTFR5cGVzLkZJTkRfUkVTVUxUKSxcbiAgICBhc3luYyByZXNvbHZlKF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQsIHF1ZXJ5SW5mbykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICBvcmRlcixcbiAgICAgICAgICBza2lwLFxuICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgIGtleXMsXG4gICAgICAgICAgaW5jbHVkZSxcbiAgICAgICAgICBpbmNsdWRlQWxsLFxuICAgICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICB9ID0gYXJncztcbiAgICAgICAgY29uc3QgeyBjb25maWcsIGF1dGgsIGluZm8gfSA9IGNvbnRleHQ7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkRmllbGRzID0gZ2V0RmllbGROYW1lcyhxdWVyeUluZm8pO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBmaW5kT2JqZWN0cyhcbiAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgd2hlcmUsXG4gICAgICAgICAgb3JkZXIsXG4gICAgICAgICAgc2tpcCxcbiAgICAgICAgICBsaW1pdCxcbiAgICAgICAgICBrZXlzLFxuICAgICAgICAgIGluY2x1ZGUsXG4gICAgICAgICAgaW5jbHVkZUFsbCxcbiAgICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgc3VicXVlcnlSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgYXV0aCxcbiAgICAgICAgICBpbmZvLFxuICAgICAgICAgIHNlbGVjdGVkRmllbGRzXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHBhcnNlR3JhcGhRTFNjaGVtYS5oYW5kbGVFcnJvcihlKTtcbiAgICAgIH1cbiAgICB9LFxuICB9O1xuXG4gIGNvbnN0IG9iamVjdHNRdWVyeSA9IG5ldyBHcmFwaFFMT2JqZWN0VHlwZSh7XG4gICAgbmFtZTogJ09iamVjdHNRdWVyeScsXG4gICAgZGVzY3JpcHRpb246ICdPYmplY3RzUXVlcnkgaXMgdGhlIHRvcCBsZXZlbCB0eXBlIGZvciBvYmplY3RzIHF1ZXJpZXMuJyxcbiAgICBmaWVsZHM6IHBhcnNlR3JhcGhRTFNjaGVtYS5ncmFwaFFMT2JqZWN0c1F1ZXJpZXMsXG4gIH0pO1xuICBwYXJzZUdyYXBoUUxTY2hlbWEuZ3JhcGhRTFR5cGVzLnB1c2gob2JqZWN0c1F1ZXJ5KTtcblxuICBwYXJzZUdyYXBoUUxTY2hlbWEuZ3JhcGhRTFF1ZXJpZXMub2JqZWN0cyA9IHtcbiAgICBkZXNjcmlwdGlvbjogJ1RoaXMgaXMgdGhlIHRvcCBsZXZlbCBmb3Igb2JqZWN0cyBxdWVyaWVzLicsXG4gICAgdHlwZTogb2JqZWN0c1F1ZXJ5LFxuICAgIHJlc29sdmU6ICgpID0+IG5ldyBPYmplY3QoKSxcbiAgfTtcbn07XG5cbmV4cG9ydCB7IGdldE9iamVjdCwgZmluZE9iamVjdHMsIGxvYWQgfTtcbiJdfQ==